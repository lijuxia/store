<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>老南塘馄饨担</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
    <link rel="stylesheet" href="../../plugin/picker/dist/css/mui.picker.min.css" />
    <style>
    	.report-table{
    		width: 100%;table-layout:fixed;background-color: #efeff4;
    	}
    	#report-hide-table{
    		width: 100%;
    		table-layout:fixed;
    		position: fixed;
    		top: 84px;
    	}
    	#hide-date{
    		width: 100%;
    		position: fixed;
    		top: 44px;
    	}
    	.report-table td{
    		line-height: 30px;
    		text-align: center;
    	}
    	.report-table th{
    		line-height: 30px;
    		text-align: center;
    	}
    </style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
	    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	    <h1 class="mui-title">报表</h1>
	    <button type="button" data-loading-text="加载中" id="submit-btn" class="mui-btn mui-btn-primary mui-pull-right" >下载</button>
	</header>
	<div class="mui-content">
		<div style="height: 40px;"></div>
		<div class="mui-input-group" id="hide-date">
	        <div class="mui-input-row">
	        	<form id="down" action="/report/updateCenterFile">
	            <label id="userResult" style="width: 40%;">日期</label>
	            <input type="text" class="mui-input-clear" style="width: 60%;" placeholder="选择日期" name="date" id="date">
	            </form>
	    	</div>
    	</div>
    	<div id="list"></div>
	</div>
    <script type="text/html" id="listTemp">
    	<table class="report-table" border="1" id="report-hide-table">
    		<thead><!--头部，放置产品名称-->
    			<tr>
    				<th rowspan="3">日期</th>
    			<% for(var i=0;i<productList.length;i++){%>
					<%var pid = productList[i].id;%>
					<%var lis = makeList[pid];%>
					<%var cols = 3%>
					<%if(lis!=null){%>
    					<%cols=cols+lis.length%>
					<%}%>
    				<th colspan="<%=cols%>"><%=productList[i].name %></th>
    			<% } %>
    			</tr>
    			<tr>
    			<% for(var i=0;i<productList.length;i++){%>
					<%var pid = productList[i].id;%>
					<%var lis = makeList[pid];%>
					<%var cols = 3%>
					<%if(lis!=null){%>
    					<%cols=cols+lis.length%>
					<%}%>
    				<th colspan="<%=cols%>"><%=productList[i].unit %></th>
    			<% } %>
    			</tr>
    			<tr>
    			<% for(var i=0;i<productList.length;i++){%>
    				<th>进</th>
    				<th>出</th>
					<%var pid = productList[i].id;%>
					<%var lis = makeList[pid];%>
					<%if(lis!=null){%>
    					<%for(var x=0;x<lis.length;x++){ %>
    						<th><%=lis[x].name%></th>
    					<%}%>
					<%}%>
    				<th style="background-color: #ddd;">存</th>
    			<% } %>
    			</tr>
    	</thead>
    	</table>
    	<table class="report-table" border="1">
    		<thead><!--头部，放置产品名称-->
    			<tr>
    				<th rowspan="3">日期</th>
    			<% for(var i=0;i<productList.length;i++){%>
					<%var pid = productList[i].id;%>
					<%var lis = makeList[pid];%>
					<%var cols = 3%>
					<%if(lis!=null){%>
    					<%cols=cols+lis.length%>
					<%}%>
    				<th colspan="<%=cols%>"><%=productList[i].name %></th>
    			<% } %>
    			</tr>
    			<tr>
    			<% for(var i=0;i<productList.length;i++){%>
					<%var pid = productList[i].id;%>
					<%var lis = makeList[pid];%>
					<%var cols = 3%>
					<%if(lis!=null){%>
    					<%cols=cols+lis.length%>
					<%}%>
    				<th colspan="<%=cols%>"><%=productList[i].unit %></th>
    			<% } %>
    			</tr>
    			<tr>
    			<% for(var i=0;i<productList.length;i++){%>
    				<th>进</th>
    				<th>出</th>
					<%var pid = productList[i].id;%>
					<%var lis = makeList[pid];%>
					<%if(lis!=null){%>
    					<%for(var x=0;x<lis.length;x++){ %>
    						<th><%=lis[x].name%></th>
    					<%}%>
					<%}%>
    				<th style="background-color: #ddd;">存</th>
    			<% } %>
    			</tr>
    		</thead>
    		<tbody>
    			<% for(var i=0;i<valueList.length;i++){ %>
    				<%var value = valueList[i];%>
    				<tr>
    					<% if(i==(valueList.length-1)){ %>
    					<td>合计</td>
    					<% }else{ %>
    					<td><%=i+1%></td>
    					<% } %>
    				<%for(var p=0;p<productList.length;p++){ %>
    					<%var id = productList[p].id;%>
    					<%var cell = value[id]; %>
						<%var lis = makeList[id];%>
    					<% if(cell == null){%>
    						<td></td>
							<%if(lis!=null){%>
		    					<%for(var x=0;x<lis.length;x++){ %>
		    						<td></td>
		    					<%}%>
							<%}%>
    						<td></td>
    						<td style="background-color: #ddd;"></td>
    					<%}else{%>
    						<td><%=cell.in%></td>
    						<td><%=cell.out%></td>
							<%if(lis!=null){%>
		    					<%for(var x=0;x<lis.length;x++){ %>
		    						<td><%=cell.makeMap[lis[x].id]%></td>
		    					<%}%>
							<%}%>
    						<td style="background-color: #ddd;"><%=cell.save%></td>
    					<%} %>
    				<%}%>
    				</tr>
    			<%}%>
    		</tbody>
    	</table>
    	<% %>
    </script>
    <script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="../../js/jquery-3.3.1.min.js" ></script>
    <script type="text/javascript" src="../../js/template-web.js" ></script>
	<script type="text/javascript" src="../../plugin/picker/dist/js/mui.picker.min.js" ></script>
	<script type="text/javascript" src="../../js/ljx.error.js" ></script>
    <script type="text/javascript">
    mui.init()
    $("#date").val(getNowFormatDate().substring(0,7));
    var dtPicker = new mui.DtPicker({type:'month'}); 
    var sendStoreName = document.getElementById('date');
	sendStoreName.addEventListener('tap', function(event) {
    dtPicker.show(function (selectItems) { 
    	var dd = selectItems.y.value+"-"+selectItems.m.value
    	if($("#date").val()!=dd){
    		$("#date").val(dd);
			getList();
    	}
    	$("#date").val(dd);
    })
	}, false);
	$(window).scroll(function(){
		var top = $(window).scrollTop();
		if(top<=0){
			$("#report-hide-table").hide();
		}else{
			$("#report-hide-table").show();
		}
	});
	mui(document.body).on('tap', '#submit-btn', function(e) {
		var btn = this;
		mui(btn).button('loading');
		$("#down").submit();
		mui($("#submit-btn")).button('reset');
	});
	$(function(){
		getList();
	})
	var getList = function(){
		var date = $("#date").val();
		mui.ajax("/report/list",{
			data:{
				date:date
			},
			dataType:'json',
			type:'get',
			success:function (data){
				if(data.succeed){
					console.log(data);
					var Carouselhtml = template('listTemp', data.value);
					console.log(Carouselhtml);
					$("#list").html(Carouselhtml);
				}else{
					errorHandle(data);
				}
			}
		});
	}
    </script>
</body>
</html>

